<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartSpend Pro</title>
    
    <!-- PWA Manifest (Embedded for Single File functionality) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiU21hcnRTcGVuZCBQcm8iLCJzaG9ydF9uYW1lIjoiU21hcnRTcGVuZCIs"start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3135/3135715.png","sizes":"512x512","type":"image/png"}]}">
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --primary: #6366f1;
            --secondary: #818cf8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --gradient-btn: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        
        .hidden { display: none !important; }
        .text-green { color: var(--accent-green); }
        .text-red { color: var(--accent-red); }
        
        /* --- Login Screen --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--bg-hover); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .error-msg { background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; word-break: break-word; text-align: left; }
        .success-msg { background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; }

        /* --- Diagnostics Bar --- */
        #db-status-bar { display: none; background: #ef4444; color: white; text-align: center; padding: 15px; font-size: 14px; width: 100%; position: absolute; top: 0; left: 0; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* --- Layout & Sidebar --- */
        .sidebar { width: 80px; background-color: #0b1120; display: flex; flex-direction: column; align-items: center; padding-top: 25px; border-right: 1px solid var(--bg-hover); z-index: 100; transition: all 0.3s ease; }
        .logo-area { font-size: 28px; background: var(--gradient-btn); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 12px; background-color: rgba(99, 102, 241, 0.1); }
        
        .nav-item { color: var(--text-muted); font-size: 20px; margin-bottom: 25px; cursor: pointer; display: flex; justify-content: center; align-items: center; height: 45px; width: 45px; border-radius: 12px; transition: 0.3s; }
        .nav-item:hover { color: white; background: var(--bg-hover); }
        .nav-item.active { color: white; background: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

        .main-content { flex: 1; padding: 25px; overflow-y: auto; scroll-behavior: smooth; position: relative; margin-top: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .mobile-logo { display: none; font-size: 24px; font-weight: 700; background: var(--gradient-btn); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .search-bar { background: var(--bg-card); padding: 10px 15px; border-radius: 12px; display: flex; align-items: center; width: 100%; max-width: 450px; border: 1px solid var(--bg-hover); }
        .search-bar input { background: transparent; border: none; color: white; margin-left: 10px; width: 100%; outline: none; font-size: 14px; }
        .user-profile-header { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 5px 10px; border-radius: 10px; transition: 0.2s; }
        .user-profile-header:hover { background: var(--bg-hover); }
        .user-avatar-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        /* --- Components --- */
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 25px; }
        
        .card { background-color: var(--bg-card); border-radius: 16px; padding: 24px; position: relative; border: 1px solid var(--bg-hover); box-shadow: var(--shadow-card); }
        .stat-label { color: var(--text-muted); font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 28px; font-weight: 600; margin-top: 8px; letter-spacing: 0.5px; }
        .stat-icon { position: absolute; top: 24px; right: 24px; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); font-size: 20px; }
        
        .btn-primary { background: var(--gradient-btn); border: none; padding: 12px 24px; border-radius: 10px; color: white; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4); }
        
        .btn-secondary { background: white; border: none; padding: 12px 24px; border-radius: 10px; color: #333; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; margin-top: 10px; }
        .btn-secondary:hover { background: #f1f5f9; }

        .btn-danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .add-btn { background: var(--primary); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; min-width: 32px; }
        .add-btn:hover { background: var(--secondary); transform: scale(1.05); }

        /* --- Profile --- */
        .profile-header-card { display: flex; align-items: center; gap: 30px; margin-bottom: 25px; }
        .profile-big-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        .profile-info h2 { font-size: 24px; margin-bottom: 5px; }
        .profile-info p { color: var(--text-muted); font-size: 14px; }
        
        .trans-item { background: var(--bg-card); padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--bg-hover); margin-bottom: 12px; }
        .trans-icon { width: 42px; height: 42px; border-radius: 50%; background: #0f172a; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; min-width: 42px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 500; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-card { background: var(--bg-card); padding: 32px; border-radius: 24px; width: 90%; max-width: 450px; border: 1px solid var(--bg-hover); position: relative; animation: slideUp 0.3s ease-out; }
        .form-input, .form-select, .form-textarea { width: 100%; background: #0f172a; border: 1px solid var(--bg-hover); padding: 14px; border-radius: 10px; color: white; outline: none; margin-bottom: 15px; font-size: 14px; display: block; color-scheme: dark; }
        
        /* Notifications */
        .notif-bell { position: relative; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); display: flex; justify-content: center; align-items: center; transition: 0.2s; margin-right: 15px; }
        .notif-bell:hover { background: var(--bg-hover); }
        .notif-badge { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background: var(--accent-red); border-radius: 50%; border: 2px solid var(--bg-card); display: none; }
        .notif-menu { position: absolute; top: 60px; right: 20px; width: 300px; background: var(--bg-card); border: 1px solid var(--bg-hover); border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 200; padding: 15px; display: none; }
        
        /* AI Chat */
        .ai-modal { position: fixed; bottom: 100px; right: 30px; width: 350px; background: var(--bg-card); border-radius: 20px; border: 1px solid var(--bg-hover); box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 400; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .ai-chat-area { height: 300px; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 10px 15px; border-radius: 12px; font-size: 13px; line-height: 1.5; max-width: 85%; }
        .msg-ai { background: #334155; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-user { background: var(--primary); align-self: flex-end; border-bottom-right-radius: 2px; }
        
        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            
            .sidebar { 
                width: 100%; height: 70px; bottom: 0; top: auto; 
                flex-direction: row; justify-content: space-around; 
                padding: 0; border-right: none; border-top: 1px solid var(--bg-hover);
                background: #0b1120; z-index: 1000; position: fixed;
            }
            
            .logo-area { display: none; } /* Use header logo instead */
            .nav-item { margin-bottom: 0; height: 100%; width: 100%; border-radius: 0; }
            .nav-item.active { box-shadow: inset 0 3px 0 0 var(--primary); background: transparent; color: var(--primary); }
            
            /* Hide non-essential nav items on mobile to save space */
            .sidebar > div:last-child { display: none; } /* Hide logout/status/install in bottom bar */
            
            .main-content { padding: 15px; padding-bottom: 90px; } /* Extra padding for bottom nav */
            
            .header { gap: 10px; }
            .mobile-logo { display: block; display: flex; align-items: center; gap: 8px; }
            
            /* Responsive Grid */
            .grid-3 { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
            
            /* Hide Search on very small screens or make it an icon */
            .search-bar { width: auto; flex: 1; }
            .search-bar input { width: 100%; }
            
            /* Profile Header changes */
            .user-profile-header div { display: none !important; } /* Hide name, show only avatar */
            
            /* AI Modal Mobile */
            .ai-modal { width: 90%; right: 5%; bottom: 80px; }
            .notif-menu { width: 90%; right: 5%; top: 60px; }
            
            /* Mobile Top Bar with Install & Logout */
            #mobile-top-actions { display: flex !important; align-items: center; gap: 15px; }
        }

        #mobile-top-actions { display: none; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- DB STATUS BAR -->
    <div id="db-status-bar">
        <strong>⚠️ Database Access Blocked!</strong><br>
        <span style="font-weight:400; opacity:0.9;">Your data is not saving because Firestore Rules are blocking it.</span><br>
        <div style="margin-top:10px; font-size:12px; background:rgba(0,0,0,0.2); padding:10px; border-radius:4px; text-align:left;">
            <strong>Fix:</strong> Go to Firebase Console -> Firestore Database -> Rules and paste:<br>
            <code style="display:block; margin-top:5px; font-family:monospace;">allow read, write: if request.auth != null;</code>
        </div>
        <button onclick="document.getElementById('db-status-bar').style.display='none'" style="margin-top:10px; background:white; color:#ef4444; border:none; padding:5px 15px; border-radius:4px; cursor:pointer; font-weight:600;">Dismiss</button>
    </div>

    <!-- REAL LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <div class="logo-area" style="margin-bottom: 20px; font-size: 32px;">
                <i class="fa-solid fa-wave-square"></i>
            </div>
            <h2 id="login-title" style="margin-bottom: 10px;">Personal Expense</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Login to manage your finances</p>
            
            <div id="login-error" class="error-msg hidden"></div>
            <div id="login-success" class="success-msg hidden"></div>

            <form onsubmit="handleLogin(event)">
                <input type="hidden" id="is-signup" value="false">
                
                <!-- Name Field (Hidden by default) -->
                <div id="signup-name-group" class="hidden">
                    <input type="text" id="signup-name" class="form-input" placeholder="Full Name">
                </div>

                <input type="email" id="login-email" class="form-input" placeholder="Email Address" required>
                <input type="password" id="login-pass" class="form-input" placeholder="Password (min 6 chars)" required>
                
                <button type="submit" id="login-btn" class="btn-primary" style="width: 100%; justify-content: center;">Sign In</button>
                
                <div style="margin: 15px 0; display: flex; align-items: center; gap: 10px; color: #64748b; font-size: 12px;">
                    <div style="flex: 1; height: 1px; background: #334155;"></div> OR <div style="flex: 1; height: 1px; background: #334155;"></div>
                </div>

                <button type="button" onclick="handleGoogleLogin()" class="btn-secondary" style="width: 100%; justify-content: center;">
                    <i class="fa-brands fa-google"></i> Sign in with Google
                </button>
            </form>
            
            <p id="toggle-text" style="margin-top: 20px; font-size: 13px; color: var(--text-muted);">
                Need an account? <span onclick="toggleSignUp()" style="color:var(--primary); cursor:pointer;">Sign Up</span>
            </p>
        </div>
    </div>

    <!-- SIDEBAR / BOTTOM NAV -->
    <nav class="sidebar hidden" id="main-sidebar">
        <!-- Desktop Logo -->
        <div class="logo-area" onclick="switchView('dashboard')">
            <i class="fa-solid fa-wallet" style="font-size: 24px; color: var(--primary);"></i>
        </div>
        
        <div class="nav-item active" onclick="switchView('dashboard', this)" title="Dashboard"><i class="fa-solid fa-border-all"></i></div>
        <div class="nav-item" onclick="switchView('analysis', this)" title="Analysis"><i class="fa-solid fa-chart-pie"></i></div>
        <div class="nav-item" onclick="switchView('transactions', this)" title="Transactions"><i class="fa-solid fa-list-ul"></i></div>
        <div class="nav-item" onclick="switchView('goals', this)" title="Goals"><i class="fa-solid fa-bullseye"></i></div>
        <div class="nav-item" onclick="switchView('budgets', this)" title="Budgets"><i class="fa-solid fa-sack-dollar"></i></div>
        <div class="nav-item" onclick="switchView('schedule', this)" title="Schedule"><i class="fa-solid fa-calendar-days"></i></div>
        
        <!-- Desktop Extra Items -->
        <div style="margin-top: auto; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px;">
            <div class="nav-item" id="install-btn" style="display:none;" onclick="installPWA()" title="Install App"><i class="fa-solid fa-download"></i></div>
            <div class="nav-item" onclick="toggleAI()" title="AI Advisor"><i class="fa-solid fa-robot"></i></div>
            <div class="nav-item" onclick="openModal('modal-contact')" title="Support"><i class="fa-regular fa-circle-question"></i></div>
            <div class="nav-item" onclick="handleLogout()" title="Logout"><i class="fa-solid fa-arrow-right-from-bracket"></i></div>
            <div id="status-indicator" style="display:none;" title="Connected"></div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content hidden" id="main-app">
        
        <!-- HEADER -->
        <div class="header">
            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass" style="color: #64748b;"></i>
                <input type="text" id="global-search" placeholder="Search..." onkeyup="handleSearch()">
                <button class="add-btn" onclick="openModal('modal-trans')">+</button>
            </div>
            
            <div style="display:flex; align-items:center;">
                <!-- Mobile Actions (Install/Logout) -->
                <div id="mobile-top-actions">
                    <i class="fa-solid fa-download" id="mobile-install-btn" style="color: var(--text-muted); cursor: pointer; display: none;" onclick="installPWA()"></i>
                    <i class="fa-solid fa-robot" onclick="toggleAI()" style="color: var(--text-muted); cursor: pointer;"></i>
                    <i class="fa-solid fa-arrow-right-from-bracket" onclick="handleLogout()" style="color: var(--text-muted); cursor: pointer;"></i>
                </div>

                <!-- Notification Bell -->
                <div class="notif-bell" onclick="toggleNotifMenu()">
                    <i class="fa-regular fa-bell" style="color: #94a3b8;"></i>
                    <div id="notif-badge" class="notif-badge"></div>
                </div>
                <!-- Notif Dropdown -->
                <div id="notif-menu" class="notif-menu">
                    <h4 style="margin-bottom:10px;">Upcoming Bills</h4>
                    <div id="notif-list" style="max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
                        <div style="color:var(--text-muted); font-size:12px;">No upcoming bills in next 3 days.</div>
                    </div>
                </div>

                <div class="user-profile-header" onclick="switchView('profile')">
                    <div style="text-align: right; display: none; display: md-block;">
                        <div style="font-size: 14px; font-weight: 600;" id="header-username">User</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Pro Member</div>
                    </div>
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" id="header-avatar" class="user-avatar-img">
                </div>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section">
            <h2 style="margin-bottom: 20px;">Dashboard</h2>
            
            <div class="grid-3">
                <div class="card">
                    <div class="stat-label">Total Balance</div>
                    <div class="stat-value" id="disp-balance">₹0.00</div>
                    <div class="stat-icon" style="color: #3b82f6;"><i class="fa-solid fa-wallet"></i></div>
                </div>
                <div class="card">
                    <div class="stat-label">Income</div>
                    <div class="stat-value text-green" id="disp-income">₹0.00</div>
                    <div class="stat-icon" style="color: #10b981;"><i class="fa-solid fa-arrow-trend-up"></i></div>
                </div>
                <div class="card">
                    <div class="stat-label">Expense</div>
                    <div class="stat-value text-red" id="disp-expense">₹0.00</div>
                    <div class="stat-icon" style="color: #ef4444;"><i class="fa-solid fa-arrow-trend-down"></i></div>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card" style="height: 350px;">
                    <div class="stat-label" style="margin-bottom: 15px;">Cash Flow Analysis</div>
                    <canvas id="cashFlowChart"></canvas>
                </div>
                <div class="card" style="height: 350px;">
                    <div class="stat-label" style="margin-bottom: 15px;">Spending Breakdown</div>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <h3 style="margin-bottom: 15px;">Recent Transactions</h3>
            <div id="recent-trans-container">
                <div style="text-align:center; padding:20px; color:#64748b;">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Loading...
                </div>
            </div>
        </div>

        <!-- VIEW: TRANSACTIONS -->
        <div id="view-transactions" class="view-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>All Transactions</h2>
                <div style="display:flex; gap:10px;">
                    <select id="filter-cat" class="form-select" style="margin-bottom:0; width:150px;" onchange="renderTransactions()">
                        <option value="All">All Categories</option>
                        <option value="Food">Food</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Transport">Transport</option>
                        <option value="Housing">Housing</option>
                        <option value="Salary">Salary</option>
                        <option value="Other">Other</option>
                    </select>
                    <button class="btn-primary" onclick="exportExcel()"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
                </div>
            </div>
            <div id="full-trans-container"></div>
        </div>

        <!-- VIEW: ANALYSIS -->
        <div id="view-analysis" class="view-section hidden">
            <h2 style="margin-bottom: 20px;">Analysis</h2>
            <div class="card">
                <div style="display: flex; justify-content: space-between;">
                    <div><div class="stat-label">Projected Savings (1 Year)</div><div class="stat-value text-green" id="projected-savings">₹0.00</div></div>
                    <div><div class="stat-label">Saving Rate</div><div class="stat-value" id="saving-rate">0%</div></div>
                </div>
                <div style="margin-top: 20px; height: 300px;"><canvas id="projectionChart"></canvas></div>
            </div>
        </div>

        <!-- VIEW: GOALS -->
        <div id="view-goals" class="view-section hidden">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Goals</h2>
                <button class="btn-primary" onclick="openModal('modal-goal')">+ New Goal</button>
            </div>
            <div id="goals-container" class="grid-2"></div>
        </div>

        <!-- VIEW: BUDGETS -->
        <div id="view-budgets" class="view-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Monthly Budgets</h2>
                <button class="btn-primary" onclick="openModal('modal-budget')">+ Set Budget</button>
            </div>
            <div id="budgets-container" class="grid-2"></div>
        </div>

        <!-- VIEW: SCHEDULE -->
        <div id="view-schedule" class="view-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Scheduled Bills</h2>
                <button class="btn-primary" onclick="openModal('modal-schedule')">+ Add Bill</button>
            </div>
            <div id="schedule-container" class="grid-2"></div>
        </div>

        <!-- VIEW: PROFILE -->
        <div id="view-profile" class="view-section hidden">
            <h2 style="margin-bottom: 20px;">Profile Settings</h2>
            
            <div class="card profile-header-card">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="profile-big-avatar">
                <div class="profile-info">
                    <h2 id="profile-name-disp">User Name</h2>
                    <p id="profile-email-disp">email@example.com</p>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 15px;">Edit Details</h3>
                <form onsubmit="saveProfile(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div><label style="font-size:12px; color:#94a3b8">Name</label><input type="text" id="p-name" class="form-input"></div>
                        <div><label style="font-size:12px; color:#94a3b8">Email</label><input type="email" id="p-email" class="form-input" disabled style="opacity:0.6"></div>
                        <div><label style="font-size:12px; color:#94a3b8">Currency</label><select id="p-currency" class="form-select"><option value="₹">INR (₹)</option><option value="$">USD ($)</option><option value="€">EUR (€)</option></select></div>
                        <div><label style="font-size:12px; color:#94a3b8">Phone</label><input type="text" id="p-phone" class="form-input"></div>
                    </div>
                    
                    <div style="margin-top: 15px; margin-bottom: 20px;">
                        <button type="button" class="btn-secondary" onclick="requestNotifs()" style="width: 100%; justify-content: center;">
                            <i class="fa-regular fa-bell"></i> Enable Notifications
                        </button>
                    </div>

                    <div style="margin-top: 25px; text-align: right;">
                         <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- AI CHAT WINDOW -->
    <div id="ai-modal" class="ai-modal hidden">
        <div style="padding: 15px; background: #1e293b; border-bottom: 1px solid var(--bg-hover); display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-wand-magic-sparkles text-green"></i> AI Advisor
            </div>
            <i class="fa-solid fa-xmark" style="cursor: pointer; padding: 5px;" onclick="toggleAI()"></i>
        </div>
        <div id="chat-history" class="ai-chat-area">
            <div class="msg msg-ai">Hello! I'm analyzing your spending patterns to give you behavioral insights. Ask me for a tip!</div>
        </div>
        <div class="ai-input" style="padding: 15px; border-top: 1px solid var(--bg-hover); display: flex; background: var(--bg-card); gap: 10px;">
            <input type="text" id="user-input" placeholder="Ask advisor..." onkeypress="handleChatEnter(event)" style="flex: 1; background: var(--bg-dark); border: 1px solid var(--bg-hover); padding: 10px 15px; border-radius: 20px; color: white; outline: none;">
            <button onclick="sendChat()" style="background:var(--primary); width:35px; height:35px; border-radius:50%; border:none; color:white; cursor:pointer;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-trans" class="modal-overlay hidden">
        <div class="modal-card">
            <i class="fa-solid fa-xmark" style="position: absolute; right: 20px; top: 20px; cursor: pointer;" onclick="closeModals()"></i>
            <h3 style="margin-bottom: 20px;">Add Transaction</h3>
            <form onsubmit="addTransaction(event)">
                <input id="t-desc" type="text" class="form-input" required placeholder="Description">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input id="t-amount" type="number" class="form-input" required placeholder="Amount">
                    <select id="t-type" class="form-select"><option value="expense">Expense</option><option value="income">Income</option></select>
                </div>
                <select id="t-cat" class="form-select"><option value="Food">Food</option><option value="Utilities">Utilities</option><option value="Shopping">Shopping</option><option value="Salary">Salary</option><option value="Transport">Transport</option><option value="Housing">Housing</option><option value="Other">Other</option></select>
                <button class="btn-primary" style="width:100%; justify-content:center;">Save</button>
            </form>
        </div>
    </div>

    <div id="modal-goal" class="modal-overlay hidden">
        <div class="modal-card">
             <i class="fa-solid fa-xmark" style="position: absolute; right: 20px; top: 20px; cursor: pointer;" onclick="closeModals()"></i>
            <h3 style="margin-bottom: 20px;">New Goal</h3>
            <form onsubmit="addGoal(event)">
                <input id="g-name" type="text" class="form-input" placeholder="Goal Name" required>
                <input id="g-target" type="number" class="form-input" placeholder="Target Amount" required>
                <input id="g-saved" type="number" class="form-input" placeholder="Saved" value="0">
                <button class="btn-primary" style="width:100%; justify-content:center;">Create</button>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="modal-budget" class="modal-overlay hidden">
        <div class="modal-card">
             <i class="fa-solid fa-xmark" style="position: absolute; right: 20px; top: 20px; cursor: pointer;" onclick="closeModals()"></i>
            <h3 style="margin-bottom: 20px;">Set Monthly Budget</h3>
            <form onsubmit="saveBudget(event)">
                <label style="font-size:12px; color:#94a3b8; display:block; margin-bottom:5px;">Category</label>
                <select id="b-cat" class="form-select">
                    <option value="Food">Food</option><option value="Utilities">Utilities</option><option value="Shopping">Shopping</option><option value="Transport">Transport</option><option value="Housing">Housing</option><option value="Other">Other</option>
                </select>
                <label style="font-size:12px; color:#94a3b8; display:block; margin-bottom:5px;">Monthly Limit</label>
                <input id="b-limit" type="number" class="form-input" placeholder="e.g. 5000" required>
                <button class="btn-primary" style="width:100%; justify-content:center;">Set Limit</button>
            </form>
        </div>
    </div>

    <!-- Schedule Bill Modal -->
    <div id="modal-schedule" class="modal-overlay hidden">
        <div class="modal-card">
             <i class="fa-solid fa-xmark" style="position: absolute; right: 20px; top: 20px; cursor: pointer;" onclick="closeModals()"></i>
            <h3 style="margin-bottom: 20px;">Schedule Recurring Bill</h3>
            <form onsubmit="addScheduledBill(event)">
                <input id="s-name" type="text" class="form-input" placeholder="Bill Name (e.g. Netflix)" required>
                <input id="s-amount" type="number" class="form-input" placeholder="Amount" required>
                <label style="font-size:12px; color:#94a3b8; display:block; margin-bottom:5px;">Next Due Date</label>
                <input id="s-date" type="date" class="form-input" required>
                <select id="s-cat" class="form-select"><option value="Utilities">Utilities</option><option value="Housing">Housing</option><option value="Food">Food</option><option value="Other">Other</option></select>
                <button class="btn-primary" style="width:100%; justify-content:center;">Schedule</button>
            </form>
        </div>
    </div>

    <!-- Contact Support Modal -->
    <div id="modal-contact" class="modal-overlay hidden">
        <div class="modal-card">
             <i class="fa-solid fa-xmark" style="position: absolute; right: 20px; top: 20px; cursor: pointer;" onclick="closeModals()"></i>
            <h3 style="margin-bottom: 20px;">Contact Support</h3>
            <form action="https://formspree.io/f/myznoqyr" method="POST">
                <input type="email" name="email" class="form-input" placeholder="Your Email" required>
                <textarea name="message" class="form-textarea" rows="4" placeholder="How can we help?" required></textarea>
                <button class="btn-primary" style="width:100%; justify-content:center;">Send Message</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs & Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendEmailVerification, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmy_f7lyfh1AP5w4fnQ-CE0edvOUaz7us",
            authDomain: "personalexpense-ff003.firebaseapp.com",
            projectId: "personalexpense-ff003",
            storageBucket: "personalexpense-ff003.firebasestorage.app",
            messagingSenderId: "1067333326410",
            appId: "1:1067333326410:web:3d506ddd04ce3e6a69f8b3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH LOGIC ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const name = document.getElementById('signup-name').value;
            const isSignUp = document.getElementById('is-signup').value === 'true';
            const btn = e.target.querySelector('button[type="submit"]');
            const errorMsg = document.getElementById('login-error');
            const successMsg = document.getElementById('login-success');

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';
            errorMsg.classList.add('hidden');
            successMsg.classList.add('hidden');

            try {
                if (isSignUp) {
                    if (!name) throw new Error("Please enter your full name.");
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;
                    
                    try { await sendEmailVerification(user); } catch (e) { console.warn("Verification email failed", e); }

                    await setDoc(doc(db, 'users', user.uid, 'settings', 'profile'), {
                        name: name, email: email, currency: '₹', phone: ''
                    }, { merge: true });

                    await signOut(auth);
                    successMsg.textContent = `Account created! We sent a verification link to ${email}. Please check your inbox and verify before logging in.`;
                    successMsg.classList.remove('hidden');
                    btn.innerHTML = 'Sign Up';

                } else {
                    const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;

                    if (!user.emailVerified) {
                        await signOut(auth);
                        throw new Error("Email not verified. Please check your inbox or spam folder.");
                    }
                }
            } catch (error) {
                console.error(error);
                btn.innerHTML = isSignUp ? 'Sign Up' : 'Sign In';
                errorMsg.textContent = "Error: " + error.message.replace('Firebase: ', '');
                errorMsg.classList.remove('hidden');
            }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                await setDoc(doc(db, 'users', user.uid, 'settings', 'profile'), {
                    name: user.displayName || user.email.split('@')[0], 
                    email: user.email, currency: '₹', phone: user.phoneNumber || ''
                }, { merge: true });
            } catch (error) {
                console.error("Google Sign-In Error", error);
                const errorMsg = document.getElementById('login-error');
                
                if (error.code === 'auth/unauthorized-domain' || error.message.includes('unauthorized domain')) {
                    const currentDomain = window.location.hostname;
                    errorMsg.innerHTML = `<strong>Domain Unauthorized:</strong><br>
                        Go to Firebase Console > Auth > Settings > Authorized Domains.<br>
                        Add this domain: <code>${currentDomain}</code>`;
                } else {
                    errorMsg.textContent = "Google Sign-In Failed: " + error.message;
                }
                errorMsg.classList.remove('hidden');
            }
        };

        window.handleLogout = () => {
            if(confirm('Are you sure you want to log out?')) {
                signOut(auth).then(() => location.reload());
            }
        };

        window.toggleSignUp = () => {
            const isSignUp = document.getElementById('is-signup').value === 'true';
            document.getElementById('is-signup').value = !isSignUp;
            document.getElementById('login-title').innerText = !isSignUp ? 'Create Account' : 'Welcome Back';
            document.getElementById('login-btn').innerText = !isSignUp ? 'Sign Up' : 'Sign In';
            
            const nameField = document.getElementById('signup-name-group');
            if(!isSignUp) {
                nameField.classList.remove('hidden');
                document.getElementById('signup-name').required = true;
            } else {
                nameField.classList.add('hidden');
                document.getElementById('signup-name').required = false;
            }
            document.getElementById('toggle-text').innerHTML = !isSignUp ? 
                'Already have an account? <span onclick="toggleSignUp()" style="color:var(--primary); cursor:pointer;">Sign In</span>' : 
                'Need an account? <span onclick="toggleSignUp()" style="color:var(--primary); cursor:pointer;">Sign Up</span>';
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-success').classList.add('hidden');
        };

        // --- PWA INSTALL LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'flex';
            document.getElementById('mobile-install-btn').style.display = 'block';
        });

        window.installPWA = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                    document.getElementById('install-btn').style.display = 'none';
                    document.getElementById('mobile-install-btn').style.display = 'none';
                }
            }
        };

        // --- NOTIFICATIONS LOGIC ---
        window.requestNotifs = async () => {
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
                return;
            }
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                alert("Notifications enabled!");
                new Notification("SmartSpend", { body: "Notifications enabled successfully!" });
                checkAndNotify(scheduledBills);
            }
        };

        function checkAndNotify(bills) {
            if (Notification.permission !== "granted") return;
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const dueBills = bills.filter(s => {
                const dueDate = new Date(s.nextDate);
                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 3;
            });

            if (dueBills.length > 0) {
                const billNames = dueBills.map(b => b.name).join(', ');
                new Notification("Upcoming Bills", {
                    body: `You have ${dueBills.length} bills due soon: ${billNames}`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'
                });
            }
        }

        // --- DATA HANDLERS ---
        let currentUser = null;
        let chartInstances = {};
        let transactions = [];
        let goals = [];
        let budgets = [];
        let scheduledBills = [];
        let userProfile = { name: 'User', email: '', currency: '₹' };
        
        let unsubProfile, unsubTrans, unsubGoals, unsubBudgets, unsubSchedule;

        onAuthStateChanged(auth, (user) => {
            const updateUI = () => {
                const loginScreen = document.getElementById('login-screen');
                const sidebar = document.getElementById('main-sidebar');
                const mainApp = document.getElementById('main-app');
                if (!loginScreen || !sidebar || !mainApp) return;

                if (user && user.emailVerified) {
                    currentUser = user;
                    loginScreen.classList.add('hidden');
                    sidebar.classList.remove('hidden');
                    mainApp.classList.remove('hidden');
                    initDataListeners(user.uid, user.email);
                } else {
                    if(unsubProfile) unsubProfile();
                    if(unsubTrans) unsubTrans();
                    if(unsubGoals) unsubGoals();
                    if(unsubBudgets) unsubBudgets();
                    if(unsubSchedule) unsubSchedule();
                    
                    loginScreen.classList.remove('hidden');
                    sidebar.classList.add('hidden');
                    mainApp.classList.add('hidden');
                }
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateUI);
            } else {
                updateUI();
            }
        });

        function initDataListeners(userId, userEmail) {
            // 1. Profile Listener
            unsubProfile = onSnapshot(doc(db, 'users', userId, 'settings', 'profile'), async (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    updateProfileUI();
                    updateDashboard(); 
                } else {
                    const defaultProfile = { name: userEmail.split('@')[0], email: userEmail, currency: '₹', phone: '' };
                    try { await setDoc(doc(db, 'users', userId, 'settings', 'profile'), defaultProfile, { merge: true }); } catch(e) { showDbError("Permission Error: " + e.message); }
                }
            }, (error) => { showDbError(error.message); });

            // 2. Transactions Listener
            const qTrans = query(collection(db, 'users', userId, 'transactions'));
            unsubTrans = onSnapshot(qTrans, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => { transactions.push({ id: doc.id, ...doc.data() }); });
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderTransactions();
                updateDashboard();
                renderBudgets(); 
            }, (error) => { showDbError(error.message); });

            // 3. Goals Listener
            const qGoals = query(collection(db, 'users', userId, 'goals'));
            unsubGoals = onSnapshot(qGoals, (snapshot) => {
                goals = [];
                snapshot.forEach((doc) => { goals.push({ id: doc.id, ...doc.data() }); });
                renderGoals();
            }, (error) => { showDbError(error.message); });

            // 4. Budgets Listener
            const qBudgets = query(collection(db, 'users', userId, 'budgets'));
            unsubBudgets = onSnapshot(qBudgets, (snapshot) => {
                budgets = [];
                snapshot.forEach((doc) => { budgets.push({ id: doc.id, ...doc.data() }); });
                renderBudgets();
            });

            // 5. Schedule Listener
            const qSchedule = query(collection(db, 'users', userId, 'schedule'));
            unsubSchedule = onSnapshot(qSchedule, (snapshot) => {
                scheduledBills = [];
                snapshot.forEach((doc) => { scheduledBills.push({ id: doc.id, ...doc.data() }); });
                scheduledBills.sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));
                renderSchedule();
                updateReminders();
                generateSmartTips();
                checkAndNotify(scheduledBills);
            });
            
            initCharts();
        }

        function showDbError(msg) {
            console.error("DB Error:", msg);
            const bar = document.getElementById('db-status-bar');
            if(msg.toLowerCase().includes('permission') || msg.toLowerCase().includes('insufficient')) {
                bar.style.display = 'block';
            } else {
                bar.innerHTML = `<strong>Error:</strong> ${msg} <button onclick="this.parentElement.style.display='none'" style="margin-left:10px;">Dismiss</button>`;
                bar.style.display = 'block';
            }
            if(transactions.length === 0) {
                document.getElementById('recent-trans-container').innerHTML = `<div style="color:#ef4444; text-align:center; padding:20px;">Failed to load data. Check red bar above.</div>`;
            }
        }

        // --- NEW FEATURES LOGIC ---

        window.saveBudget = async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            const cat = document.getElementById('b-cat').value;
            const limit = parseFloat(document.getElementById('b-limit').value);
            await setDoc(doc(db, 'users', currentUser.uid, 'budgets', cat), {
                category: cat, limit: limit
            });
            window.closeModals();
            e.target.reset();
        };

        function renderBudgets() {
            const container = document.getElementById('budgets-container');
            const cur = userProfile.currency || '₹';
            container.innerHTML = '';

            if (budgets.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#64748b;">No budgets set.</div>';
                return;
            }

            const currentMonth = new Date().toISOString().slice(0, 7); 
            const spending = {};
            transactions.forEach(t => {
                if (t.type === 'expense' && t.date.startsWith(currentMonth)) {
                    spending[t.category] = (spending[t.category] || 0) + t.amount;
                }
            });

            budgets.forEach(b => {
                const spent = spending[b.category] || 0;
                const percent = Math.min(100, (spent / b.limit) * 100);
                const color = percent > 90 ? '#ef4444' : (percent > 70 ? '#f59e0b' : '#10b981');
                
                container.innerHTML += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <h4 style="margin:0;">${b.category}</h4>
                        <span style="font-size:12px; color:${color}; font-weight:600;">${percent.toFixed(0)}%</span>
                    </div>
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px;">
                        Spent ${cur}${spent} of ${cur}${b.limit}
                    </div>
                    <div style="height:8px; background:#0f172a; border-radius:4px; overflow:hidden;">
                        <div style="height:100%; width:${percent}%; background:${color}; transition:width 0.5s;"></div>
                    </div>
                </div>`;
            });
        }

        window.addScheduledBill = async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            const name = document.getElementById('s-name').value;
            const amount = parseFloat(document.getElementById('s-amount').value);
            const date = document.getElementById('s-date').value;
            const cat = document.getElementById('s-cat').value;

            await addDoc(collection(db, 'users', currentUser.uid, 'schedule'), {
                name, amount, nextDate: date, category: cat
            });
            window.closeModals();
            e.target.reset();
        };

        window.payBill = async (id, name, amount, cat, dateStr) => {
            if(!confirm(`Mark ${name} as paid? This will create a transaction and move due date to next month.`)) return;
            
            await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), {
                desc: name, amount: amount, type: 'expense', category: cat,
                date: new Date().toISOString().split('T')[0], createdAt: Date.now()
            });

            // FIX: Reliable date parsing and month increment
            // Split YYYY-MM-DD to avoid timezone issues
            const [y, m, d] = dateStr.split('-').map(Number);
            // Create date object (Month is 0-indexed in JS Date)
            const oldDate = new Date(y, m - 1, d); 
            // Add 1 to month (JS handles year rollover automatically)
            oldDate.setMonth(oldDate.getMonth() + 1);
            
            // Format back to YYYY-MM-DD
            const newY = oldDate.getFullYear();
            const newM = String(oldDate.getMonth() + 1).padStart(2, '0');
            const newD = String(oldDate.getDate()).padStart(2, '0');
            const newDateStr = `${newY}-${newM}-${newD}`;

            await updateDoc(doc(db, 'users', currentUser.uid, 'schedule', id), {
                nextDate: newDateStr
            });
            alert("Bill Paid!");
        };

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            const cur = userProfile.currency || '₹';
            container.innerHTML = '';

            if(scheduledBills.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#64748b;">No scheduled bills.</div>';
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            scheduledBills.forEach(s => {
                const dueDate = new Date(s.nextDate);
                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                let statusColor = '#10b981'; 
                let statusText = `Due in ${diffDays} days`;

                if(diffDays < 0) { statusColor = '#ef4444'; statusText = `Overdue by ${Math.abs(diffDays)} days`; }
                else if(diffDays === 0) { statusColor = '#f59e0b'; statusText = 'Due Today'; }
                else if(diffDays <= 3) { statusColor = '#f59e0b'; }

                container.innerHTML += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div>
                            <div style="font-weight:600;">${s.name}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${s.category}</div>
                        </div>
                        <div style="font-size:18px; font-weight:600;">${cur}${s.amount}</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:12px; color:${statusColor}; font-weight:500;">
                            <i class="fa-regular fa-clock"></i> ${statusText} (${s.nextDate})
                        </span>
                        <button class="btn-primary" style="padding:5px 12px; font-size:12px;" onclick="payBill('${s.id}', '${s.name}', ${s.amount}, '${s.category}', '${s.nextDate}')">Pay Now</button>
                    </div>
                </div>`;
            });
        }

        function updateReminders() {
            const list = document.getElementById('notif-list');
            const badge = document.getElementById('notif-badge');
            list.innerHTML = '';
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            let count = 0;
            scheduledBills.forEach(s => {
                const dueDate = new Date(s.nextDate);
                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if(diffDays <= 3) { 
                    count++;
                    const color = diffDays < 0 ? '#ef4444' : '#f59e0b';
                    const txt = diffDays < 0 ? 'Overdue' : (diffDays === 0 ? 'Today' : `in ${diffDays} days`);
                    list.innerHTML += `
                        <div style="padding:10px; background:var(--bg-dark); border-radius:8px; border-left:3px solid ${color};">
                            <div style="font-size:13px; font-weight:600;">${s.name}</div>
                            <div style="font-size:11px; color:var(--text-muted);">Due ${txt} • ${userProfile.currency}${s.amount}</div>
                        </div>
                    `;
                }
            });

            if(count > 0) {
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
                list.innerHTML = '<div style="color:var(--text-muted); font-size:12px; text-align:center;">No upcoming bills in next 3 days.</div>';
            }
        }

        window.toggleNotifMenu = () => {
            const menu = document.getElementById('notif-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };

        window.handleChatEnter = (e) => { if(e.key === 'Enter') sendChat(); }
        
        window.sendChat = () => {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;
            
            addMsg(text, 'user');
            input.value = '';
            
            setTimeout(() => {
                let reply = "I can analyze your spending habits. Ask me about your 'top expense', 'health score', or 'subscriptions'.";
                const lower = text.toLowerCase();
                
                if(lower.includes('health')) {
                    reply = generateSmartTips(true); 
                } else if(lower.includes('top') || lower.includes('most')) {
                    const breakdown = getCategoryBreakdown();
                    const top = Object.entries(breakdown).sort((a,b) => b[1] - a[1])[0];
                    if(top) reply = `Your top spending category is ${top[0]} with ${userProfile.currency}${top[1]}.`;
                    else reply = "You don't have enough transactions yet.";
                } else if(lower.includes('sub') || lower.includes('recurring')) {
                    const subs = detectSubscriptions();
                    if(subs.length > 0) reply = `I found ${subs.length} potential subscriptions: ${subs.join(', ')}.`;
                    else reply = "I haven't detected any recurring payments yet.";
                }
                
                addMsg(reply, 'ai');
            }, 600);
        };

        function addMsg(text, sender) {
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerText = text;
            const hist = document.getElementById('chat-history');
            hist.appendChild(div);
            hist.scrollTop = hist.scrollHeight;
        }

        window.toggleAI = () => {
            document.getElementById('ai-modal').classList.toggle('hidden');
            if(!document.getElementById('ai-modal').classList.contains('hidden')) {
                const tips = generateSmartTips(true);
                if(tips) addMsg(tips, 'ai');
            }
        };

        function getCategoryBreakdown() {
            const catTotals = {};
            transactions.forEach(t => { 
                if(t.type === 'expense') catTotals[t.category] = (catTotals[t.category] || 0) + t.amount; 
            });
            return catTotals;
        }

        function detectSubscriptions() {
            const sigs = {};
            const suspected = [];
            transactions.forEach(t => {
                if(t.type === 'expense') {
                    const key = `${t.desc}-${t.amount}`;
                    if(sigs[key]) suspected.push(t.desc);
                    else sigs[key] = true;
                }
            });
            return [...new Set(suspected)];
        }

        function generateSmartTips(returnText = false) {
            let income = 0, expense = 0;
            transactions.forEach(t => { if(t.type === 'income') income+=t.amount; else expense+=t.amount; });
            
            const ratio = income > 0 ? (expense / income) * 100 : 0;
            let status = "Stable";
            let advice = "Keep tracking your expenses.";

            if(ratio > 90) { 
                status = "Critical"; 
                advice = "You are spending almost everything you earn. Try to cut down on discretionary spending."; 
            } else if(ratio < 50 && income > 0) {
                status = "Excellent";
                advice = "You have a great savings rate! Consider increasing your investment goals.";
            }

            const breakdown = getCategoryBreakdown();
            const topCat = Object.entries(breakdown).sort((a,b) => b[1] - a[1])[0];
            
            const msg = `Financial Health: ${status}. ${advice} Your top spending is in ${topCat ? topCat[0] : 'unknown'}.`;
            return returnText ? msg : null;
        }

        window.addTransaction = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const btn = e.target.querySelector('button');
            btn.innerText = "Saving...";
            const desc = document.getElementById('t-desc').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const type = document.getElementById('t-type').value;
            const cat = document.getElementById('t-cat').value;

            try {
                await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), {
                    desc, amount, type, category: cat,
                    date: new Date().toISOString().split('T')[0],
                    createdAt: Date.now()
                });
                window.closeModals();
                e.target.reset();
            } catch (err) { alert("Error adding transaction: " + err.message); } 
            finally { btn.innerText = "Save"; }
        };

        window.addGoal = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const name = document.getElementById('g-name').value;
            const target = parseFloat(document.getElementById('g-target').value);
            const saved = parseFloat(document.getElementById('g-saved').value);
            await addDoc(collection(db, 'users', currentUser.uid, 'goals'), {
                name, target, saved, createdAt: Date.now()
            });
            window.closeModals();
            e.target.reset();
        };
        
        window.updateGoal = async (id, amount) => {
             if (!currentUser) return;
             const goal = goals.find(g => g.id === id);
             if (goal) {
                 await updateDoc(doc(db, 'users', currentUser.uid, 'goals', id), {
                     saved: goal.saved + amount
                 });
             }
        };

        window.saveProfile = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const name = document.getElementById('p-name').value;
            const phone = document.getElementById('p-phone').value;
            const currency = document.getElementById('p-currency').value;
            await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'profile'), {
                name, phone, currency, email: userProfile.email
            }, { merge: true });
            alert("Profile Updated!");
            window.switchView('dashboard');
        };

        function updateProfileUI() {
            document.getElementById('header-username').innerText = userProfile.name || 'User';
            document.getElementById('profile-name-disp').innerText = userProfile.name || 'User';
            document.getElementById('profile-email-disp').innerText = userProfile.email;
            document.getElementById('p-name').value = userProfile.name || '';
            document.getElementById('p-email').value = userProfile.email || '';
            document.getElementById('p-phone').value = userProfile.phone || '';
            document.getElementById('p-currency').value = userProfile.currency || '₹';
        }

        function updateDashboard() {
            const cur = userProfile.currency || '₹';
            let income = 0, expense = 0;
            transactions.forEach(t => {
                if(t.type === 'income') income += t.amount;
                else expense += t.amount;
            });
            let balance = income - expense;
            document.getElementById('disp-balance').innerText = `${cur}${balance.toLocaleString()}`;
            document.getElementById('disp-income').innerText = `+${cur}${income.toLocaleString()}`;
            document.getElementById('disp-expense').innerText = `-${cur}${expense.toLocaleString()}`;
            
            // Fix: Improve projection logic
            let savingsRate = income > 0 ? ((income - expense) / income) * 100 : 0;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            let monthInc = 0, monthExp = 0;
            transactions.forEach(t => {
                if(t.date.startsWith(currentMonth)) {
                    if(t.type === 'income') monthInc += t.amount;
                    else monthExp += t.amount;
                }
            });
            let monthlySavings = monthInc - monthExp;
            if(monthlySavings < 0) monthlySavings = 0;
            let projected = monthlySavings * 12; 

            document.getElementById('saving-rate').innerText = `${savingsRate.toFixed(1)}%`;
            document.getElementById('projected-savings').innerText = `${cur}${projected.toLocaleString()}`;
            updateCharts();
        }

        window.renderTransactions = () => {
            const cur = userProfile.currency || '₹';
            const container = document.getElementById('recent-trans-container');
            const fullContainer = document.getElementById('full-trans-container');
            const filter = document.getElementById('filter-cat') ? document.getElementById('filter-cat').value : 'All';
            
            let html = '';
            
            const filtered = filter === 'All' ? transactions : transactions.filter(t => t.category === filter);

            filtered.forEach(t => {
                const isInc = t.type === 'income';
                const color = isInc ? 'text-green' : 'text-red';
                let catIcon = 'fa-sack-dollar';
                if(t.category === 'Food') catIcon = 'fa-burger';
                else if(t.category === 'Utilities') catIcon = 'fa-bolt';
                else if(t.category === 'Shopping') catIcon = 'fa-bag-shopping';
                else if(t.category === 'Transport') catIcon = 'fa-car';
                else if(t.category === 'Housing') catIcon = 'fa-house';
                else if(t.category === 'Salary') catIcon = 'fa-money-bill-wave';
                else if(t.category === 'Other') catIcon = 'fa-circle-question';
                
                html += `<div class="trans-item">
                    <div style="display: flex; align-items: center;">
                        <div class="trans-icon ${color}"><i class="fa-solid ${catIcon}"></i></div>
                        <div><div style="font-weight: 600; font-size: 15px;">${t.desc}</div><div style="font-size: 12px; color: var(--text-muted);">${t.category} • ${t.date}</div></div>
                    </div>
                    <div class="${color}" style="font-weight: 700; font-size: 16px;">${isInc ? '+' : '-'}${cur}${t.amount.toLocaleString()}</div>
                </div>`;
            });
            if(filtered.length === 0) html = '<div style="text-align:center; color:#64748b; padding:20px;">No transactions found.</div>';
            if(container) container.innerHTML = html;
            if(fullContainer) fullContainer.innerHTML = html;
        }

        function renderGoals() {
            const cur = userProfile.currency || '₹';
            const container = document.getElementById('goals-container');
            container.innerHTML = '';
            goals.forEach(g => {
                const percent = Math.min(100, (g.saved / g.target) * 100);
                container.innerHTML += `<div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3 style="font-size:16px;">${g.name}</h3>
                        <div style="background:#334155; padding:5px 10px; border-radius:10px; font-size:12px;">${percent.toFixed(0)}%</div>
                    </div>
                    <div style="color:var(--text-muted); font-size:13px; margin-bottom:10px;">${cur}${g.saved.toLocaleString()} of ${cur}${g.target.toLocaleString()}</div>
                    <div style="height:8px; background:#0f172a; border-radius:4px; overflow:hidden;"><div style="height:100%; width:${percent}%; background:var(--gradient-btn); transition: width 1s;"></div></div>
                    <div style="margin-top:15px;"><button class="btn-primary" style="padding: 5px 10px; font-size:12px; width:100%; justify-content:center;" onclick="updateGoal('${g.id}', 1000)">+ ${cur}1,000</button></div>
                </div>`;
            });
            if(goals.length === 0) container.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#64748b;">No goals set. Create one!</div>';
        }

        function initCharts() {
            const ctx1 = document.getElementById('cashFlowChart');
            const ctx2 = document.getElementById('categoryChart');
            const ctx3 = document.getElementById('projectionChart');
            if(ctx1) chartInstances.cash = new Chart(ctx1, { type: 'line', data: { labels: [], datasets: [{ label: 'Income', data: [], borderColor: '#10b981', tension: 0.4 }, { label: 'Expense', data: [], borderColor: '#ef4444', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: {color: '#94a3b8'} } }, scales: { y: { grid: { color: '#334155' }, ticks: {color: '#94a3b8'} }, x: { grid: { display: false }, ticks: {color: '#94a3b8'} } } } });
            // Fix: Add more colors
            const bgColors = ['#ef4444', '#f59e0b', '#10b981', '#6366f1', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
            if(ctx2) chartInstances.cat = new Chart(ctx2, { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: bgColors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } } });
            // Added projection chart init
            if(ctx3) chartInstances.proj = new Chart(ctx3, { type: 'bar', data: { labels: ['Current', '+1 Year', '+3 Years'], datasets: [{ label: 'Savings', data: [], backgroundColor: '#3b82f6', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#334155' }, ticks: {color: '#94a3b8'} }, x: { grid: { display: false }, ticks: {color: '#94a3b8'} } } } });
        }

        function updateCharts() {
            if(!chartInstances.cat) return;
            const catTotals = {};
            transactions.forEach(t => { if(t.type === 'expense') catTotals[t.category] = (catTotals[t.category] || 0) + t.amount; });
            chartInstances.cat.data.labels = Object.keys(catTotals);
            chartInstances.cat.data.datasets[0].data = Object.values(catTotals);
            chartInstances.cat.update();
            
            const recent = [...transactions].slice(0, 10).reverse(); 
            chartInstances.cash.data.labels = recent.map(t => t.date.slice(5));
            chartInstances.cash.data.datasets[0].data = recent.map(t => t.type==='income'?t.amount:0);
            chartInstances.cash.data.datasets[1].data = recent.map(t => t.type==='expense'?t.amount:0);
            chartInstances.cash.update();

            // Update Projection Chart
            if(chartInstances.proj) {
                let balance = 0;
                transactions.forEach(t => { if(t.type === 'income') balance += t.amount; else balance -= t.amount; });
                
                const currentMonth = new Date().toISOString().slice(0, 7);
                let mInc = 0, mExp = 0;
                transactions.forEach(t => {
                    if(t.date.startsWith(currentMonth)) {
                        if(t.type === 'income') mInc += t.amount;
                        else mExp += t.amount;
                    }
                });
                let monthlySavings = mInc - mExp;
                if(monthlySavings < 0) monthlySavings = 0;

                chartInstances.proj.data.datasets[0].data = [
                    balance,
                    balance + (monthlySavings * 12),
                    balance + (monthlySavings * 36)
                ];
                chartInstances.proj.update();
            }
        }

        window.exportExcel = () => {
            let csv = "\uFEFFDescription,Amount,Type,Category,Date\n";
            transactions.forEach(t => csv += `"${t.desc.replace(/"/g, '""')}",${t.amount},"${t.type}","${t.category}","${t.date}"\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `SmartSpend_Data.csv`;
            link.click();
        }

        window.switchView = function(id, el) {
            document.querySelectorAll('.view-section').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) {
                el.classList.add('active');
            } else if (id !== 'profile') {
                const matchingNav = document.querySelector(`.nav-item[onclick*="'${id}'"]`);
                if(matchingNav) matchingNav.classList.add('active');
            }
        };

        window.openModal = function(id) { document.getElementById(id).classList.remove('hidden'); };
        window.closeModals = function() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); };
        window.handleSearch = function() {
            const query = document.getElementById('global-search').value.toLowerCase();
            document.querySelectorAll('.trans-item').forEach(item => {
                item.style.display = item.innerText.toLowerCase().includes(query) ? 'flex' : 'none';
            });
        };
    </script>
</body>
</html>
