<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Firebase App</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; }
        .auth-container, .data-container { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
        input, button { margin: 5px 0; padding: 8px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background-color: #4CAF50; color: white; border: none; }
        #app-status { font-weight: bold; margin-bottom: 15px; }
        #user-info { margin-top: 10px; padding: 10px; background-color: #f0f0f0; }
        .error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>AI Finance Pro App</h1>
    <p id="app-status">Status: Initializing...</p>
    <p id="error-message" class="error"></p>

    <div id="auth-ui">
        <h2>Authentication ðŸ”‘</h2>
        <div class="auth-container">
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-password" placeholder="Password">
            <button id="signup-btn">Sign Up</button>
            <button id="login-btn">Log In</button>
        </div>
    </div>

    <div id="logged-in-ui" style="display: none;">
        <h2>User Info</h2>
        <div id="user-info"></div>
        <button id="logout-btn" style="background-color: #f44336;">Log Out</button>

        <h2>Database (Firestore) ðŸ’¾</h2>
        <div class="data-container">
            <h3>Add Finance Post</h3>
            <input type="text" id="post-title" placeholder="Finance Insight Title">
            <button id="add-post-btn">Add Post</button>

            <h3>Recent Insights</h3>
            <ul id="posts-list"></ul>
        </div>
    </div>

    <script type="module">
        // ----------------------------------------------------
        // I. IMPORTS AND CONFIGURATION
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // YOUR PROVIDED CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDMhGK6-Z1QtAA7KanzFFjIaccHyg54f9o",
            authDomain: "aifinancepro-9b801.firebaseapp.com",
            projectId: "aifinancepro-9b801",
            storageBucket: "aifinancepro-9b801.firebasestorage.app",
            messagingSenderId: "265552616833",
            appId: "1:265552616833:web:714fae18f3ee0070915c80",
            measurementId: "G-JYEYE29HB6"
        };

        // Initialize Firebase and Services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ----------------------------------------------------
        // II. UI ELEMENTS AND STATE
        // ----------------------------------------------------
        const statusEl = document.getElementById('app-status');
        const errorEl = document.getElementById('error-message');
        const authUI = document.getElementById('auth-ui');
        const loggedInUI = document.getElementById('logged-in-ui');
        const userInfoEl = document.getElementById('user-info');
        const postsList = document.getElementById('posts-list');
        const emailInput = document.getElementById('auth-email');
        const passwordInput = document.getElementById('auth-password');
        const postTitleInput = document.getElementById('post-title');
        
        // Buttons
        const signupBtn = document.getElementById('signup-btn');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const addPostBtn = document.getElementById('add-post-btn');

        let unsubscribeFromPosts = null; // Holds the Firestore listener function

        // Helper function to show errors
        function displayError(message) {
            errorEl.textContent = `Error: ${message}`;
        }
        
        // ----------------------------------------------------
        // III. AUTHENTICATION HANDLERS
        // ----------------------------------------------------

        signupBtn.addEventListener('click', async () => {
            errorEl.textContent = ''; // Clear previous errors
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                displayError(error.message);
            }
        });

        loginBtn.addEventListener('click', async () => {
            errorEl.textContent = '';
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                displayError(error.message);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            errorEl.textContent = '';
            try {
                await signOut(auth);
            } catch (error) {
                displayError(error.message);
            }
        });

        // ----------------------------------------------------
        // IV. FIRESTORE DATABASE HANDLERS
        // ----------------------------------------------------

        addPostBtn.addEventListener('click', async () => {
            errorEl.textContent = '';
            const title = postTitleInput.value;
            const user = auth.currentUser;

            if (!title || !user) {
                displayError("Please enter a title and ensure you are logged in.");
                return;
            }

            try {
                await addDoc(collection(db, "finance_insights"), {
                    title: title,
                    userId: user.uid,
                    userName: user.email,
                    createdAt: serverTimestamp() // Time for proper sorting
                });
                postTitleInput.value = ''; // Clear input
            } catch (e) {
                displayError("Error adding document: " + e.message);
            }
        });

        function startPostsListener() {
            // Define the query: get posts, ordered by creation date (newest first)
            const postsQuery = query(collection(db, "finance_insights"), orderBy("createdAt", "desc"));

            // Set up a real-time listener (onSnapshot)
            unsubscribeFromPosts = onSnapshot(postsQuery, (snapshot) => {
                postsList.innerHTML = ''; // Clear the current list
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Loading...';
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${data.title}</strong><br><small>by ${data.userName} on ${date}</small>`;
                    postsList.appendChild(li);
                });
            }, (error) => {
                displayError("Firestore Listener Error: " + error.message);
            });
        }
        
        // ----------------------------------------------------
        // V. AUTH STATE MONITOR (The core loop)
        // ----------------------------------------------------

        onAuthStateChanged(auth, (user) => {
            errorEl.textContent = ''; // Clear errors on state change
            if (user) {
                // USER IS LOGGED IN
                statusEl.textContent = `Status: Logged In as ${user.email}`;
                userInfoEl.innerHTML = `
                    <strong>User ID:</strong> ${user.uid}<br>
                    <strong>Email:</strong> ${user.email}
                `;
                authUI.style.display = 'none';
                loggedInUI.style.display = 'block';

                // Start data listener (if not already running)
                if (!unsubscribeFromPosts) {
                    startPostsListener();
                }

            } else {
                // USER IS LOGGED OUT
                statusEl.textContent = 'Status: Please Log In or Sign Up';
                authUI.style.display = 'block';
                loggedInUI.style.display = 'none';

                // Stop data listener (to save resources)
                if (unsubscribeFromPosts) {
                    unsubscribeFromPosts();
                    unsubscribeFromPosts = null;
                    postsList.innerHTML = '';
                }
            }
        });
    </script>
</body>
</html>
